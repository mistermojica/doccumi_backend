<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

	<script src="js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
	<script src="js/script.js" crossorigin="anonymous"></script>

	<script type="text/javascript">

		$(function() {


		});

		var globalData = JSON.parse(atob(getCookie("globalData")));

		//const web3 = new Web3("http://127.0.0.1:7545");
		const web3 = new Web3(window.ethereum);
		signData = async () => {
			//const { web3, accounts, contract } = this.state;
			var signer = "0xaaEA9aef215011737027a42C26C181B1A92895A3";
			var deadline = Date.now() + 100000;
			console.log(deadline);
			var x = 157;
			web3.currentProvider.send({
				method: 'net_version',
				params: [],
				jsonrpc: "2.0"
			}, function (err, result) {
				const netId = result.result;
				console.log("netId", netId);
				const msgParams = JSON.stringify({
					types:
					{
						EIP712Domain: [
							{ name: "name", type: "string" },
							{ name: "version", type: "string" },
							{ name: "chainId", type: "uint256" },
							{ name: "verifyingContract", type: "address" }
						],
						set: [
							{ name: "Informacion", type: "string" },
							{ name: "Laboratorio", type: "string" },
							{ name: "Prueba", type: "string" },
							{ name: "Fecha", type: "string" }
						]
					},
					//make sure to replace verifyingContract with address of deployed contract
					primaryType: "set",
					domain: { name: "CODIKA BLOCKCHAIN", version: "1", chainId: 1337, verifyingContract: "0x8A2C86a2C7D5e060a8f815535e616733EFd5302D" },
					message: {
						Informacion: "Para agregar este resultado a su expediente, por favor FIRME la transacción.",
						Laboratorio: globalData.result.proveedor,
						Prueba: globalData.result.tipo_resultado,
						Fecha: globalData.result.fecha
					}
				});

				console.log("msgParams:", msgParams);
				
				var from = signer;
				console.log('CLICKED, SENDING PERSONAL SIGN REQ', 'from', from, msgParams)
				var params = [from, msgParams]
				console.dir(params)
				var method = 'eth_signTypedData_v3'
				web3.currentProvider.send({
					method,
					params,
					from,
				}, async function (err, result) {
					if (err){
						// console.log("NO FIRMO!");
						window.location.href = "upload.html";
					} 
					if (result.error) {
						// alert("NO FIRMÓ!");
						console.log("result.error.message:", result.error.message);
						console.error('ERROR', result);
						// return true;
					}
					else {
						console.log('TYPED SIGNED:' + JSON.stringify(result.result));
						console.log("FIRMÓ!");

						$("#walletanswer").html("El usuario ha firmado la transacción, el expediente se ha guardado en su Wallet.");

						var hiddenElement = document.createElement('a');
						hiddenElement.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(globalData.result.analiticas));
						hiddenElement.target = '_blank';
						hiddenElement.download = "analiticas.json";
						hiddenElement.click();

						createContract();

						const signature = result.result.substring(2);
						const r = "0x" + signature.substring(0, 64);
						const s = "0x" + signature.substring(64, 128);
						const v = parseInt(signature.substring(128, 130), 16);
						console.log("r:", r);
						console.log("s:", s);
						console.log("v:", v);
						//await contract.methods.executeSetIfSignatureMatch(v, r, s, signer, deadline, x).send({ from: accounts[0] });
					}
				})
			})
		}
		signData();

		function createContract() {

			// return new Promise((resolve, reject) => {

			$.ajax({
				type: 'GET',
				dataType: "json",
				url: "http://192.168.10.29:4000/createContract",
				data: {}
			}).
			done(function(data, textStatus){
				if (data) {
					// resolve(data);
				}
				else {
					console.log("loadPruebas || textStatus:", textStatus);
					// reject(data);
				}
			}).
			fail(function(jqXHR, textStatus) {
				// mlCL("loadPruebas || textStatus:", textStatus);
				// reject(textStatus);
			}).
			always(function (){
				// hideLoading();
			});
			// });
		}
		
	</script>
    <title>Esperando aprobación...</title>

    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<link href="css/style.css" rel="stylesheet">

  </head>
  <body>

    <div class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			<br>
			<div class="h-100 p-5 m-2 border bg-primary rounded-3" style="--bs-bg-opacity: .1;">
				<img src="https://www.codika.net/images/logo.svg" width="200" alt="CODIKA">
				<br>
				<br>
				<h2>
					Respuesta:
				</h2>
				<br>
				<div id="container" ></div>
				<h5 id="walletanswer">
					Esperando aprobación...
				</h5>
				<!-- <p>
					Seleccione un archivo en formato PDF desde su computadora para ser convertido a data JSON.
				</p> -->
				<!-- <form role="form" method="POST" action="/ocrtraces/convertpdftopng" enctype="multipart/form-data">
					<div class="custom-file">
						<label for="filename" class="form-label">Archivo PDF:</label>
						<input class="form-control" type="file" id="filename" name="filename">
					</div> -->
					<!-- <div class="form-group">						
						<input type="file" class="form-control-file" id="exampleInputFile">
					</div> -->
					<br>
					<!-- <label for="analysis" class="form-label">Tipo de Análisis:</label>
					<select class="form-select" aria-label="Default select example" id="analysis" name="analysis">
						<option selected>Elija un tipo de análisis</option>
						<option value="HEMOGRAMA">HEMOGRAMA</option>
					</select> -->
					<!-- <br>
					<button type="submit" class="btn btn-primary">
						Enviar
					</button>
				</form> -->
			</div>
		</div>
	</div>
</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>